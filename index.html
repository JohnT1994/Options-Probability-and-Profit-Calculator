<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Options Probability and Profit Calculator| VIX </title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
  <style>
    :root { 
      --primary: #007bff; --success: #28a745; --accent: #6f42c1; --danger: #ff4d4d;
      --glass: rgba(0, 0, 0, 0.9); 
    }

    body { 
      font-family: 'Segoe UI', sans-serif; 
      background-image: url('https://i.imgur.com/nVWumk7.png'); 
      background-size: cover; background-position: center; background-attachment: fixed;
      color: #ffffff; max-width: 950px; margin: 2rem auto; padding: 0 1rem; 
    }

    .container { 
      background: var(--glass); backdrop-filter: blur(15px);
      padding: 2.5rem; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 12px 50px rgba(0,0,0,0.8);
    }

    /* VIX BANNER */
    .vix-banner {
      display: flex; justify-content: space-between; align-items: center;
      background: linear-gradient(90deg, rgba(111, 66, 193, 0.2), rgba(0, 123, 255, 0.2));
      padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .vix-val { font-size: 1.5rem; font-weight: bold; color: #a282e8; }
    .vix-meta { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2rem; }
    .ticket-row { display: flex; gap: 0.5rem; align-items: flex-end; grid-column: span 2; }
    .ticket-row div { flex: 1; }

    label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85rem; color: #bbb; }
    
    input, select { 
      width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; 
      background: #ffffff; color: #000000; font-size: 0.95rem; box-sizing: border-box;
    }
    input[readonly] { background: #e9ecef; cursor: not-allowed; }

    button { padding: 0.85rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-fetch { background: var(--success); color: white; }
    .btn-calc { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; grid-column: span 2; margin-top: 10px; }
    button:hover { filter: brightness(1.1); transform: translateY(-1px); }

    #results { margin-top: 2.5rem; display: none; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 2rem; }
    
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-item { background: rgba(255, 255, 255, 0.05); padding: 1.2rem; border-radius: 12px; border-left: 4px solid var(--primary); }
    .summary-item label { color: #888; text-transform: uppercase; font-size: 0.65rem; }
    .summary-item span { font-size: 1.2rem; font-weight: bold; display: block; margin-top: 5px; }


    .chart-container { background: rgba(0,0,0,0.4); padding: 1.5rem; border-radius: 15px; margin: 1.5rem 0; border: 1px solid rgba(255,255,255,0.1); height: 450px; position: relative; }
    .greeks-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.6rem; }
    .greek-card { background: rgba(255, 255, 255, 0.08); padding: 1rem 0.5rem; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.1); cursor: help; }
    .greek-name { font-size: 0.7rem; color: #4db8ff; font-weight: bold; display: block; margin-bottom: 4px; }
    .greek-val { font-size: 1rem; font-weight: 700; color: #fff; }

    .scenario-table { width: 100%; margin-top: 1rem; border-collapse: collapse; font-size: 0.85rem; }
    .scenario-table th, td { padding: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }

    footer { margin-top: 3rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; text-align: left; }
    .license-box { background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; font-size: 0.75rem; color: #999; margin-bottom: 1rem; }
    .disclaimer { font-size: 0.7rem; color: #666; text-align: justify; margin-bottom: 1rem; }

    @media (max-width: 600px) { .grid-form, .greeks-grid { grid-template-columns: 1fr; } .ticket-row { flex-direction: column; } }
  </style>
</head>
<body>

<div class="container">
  <div class="vix-banner">
    <div>
      <div class="vix-meta">Market Volatility Index (VIX)</div>
      <div id="vixTime" style="font-size: 0.65rem; color: #888;">Fetching latest fear gauge...</div>
    </div>
    <div class="vix-val" id="vixVal">--.--</div>
  </div>

  <h1 style="text-align:center; margin-top:0; letter-spacing: 1px;">Options Probability and Profit Calculator</h1>

  <form id="optionForm" class="grid-form">
    
    <div class="ticket-row">
  <div style="flex: 1; position: relative;">
    <label>Ticket Symbol</label>
    <input type="text" id="symbol" placeholder="e.g. TSLA" />
    <span id="companyName" style="display: block; margin-top: 6px; font-size: 0.95rem; color: #ddd; font-weight: 500;"></span>
  </div>
  <img id="stockLogo" 
       style="width: 48px; height: 48px; object-fit: contain; display: none; margin-left: 12px; border-radius: 8px; background: rgba(255,255,255,0.1);" 
       alt="Company Logo">
  <button type="button" class="btn-fetch" onclick="fetchTicketData()">Fetch Market Price &</button>
</div>

    <div><label>Stock Price ($)</label><input type="number" id="stockPrice" step="0.01" /></div>
    <div><label>Contracts (Qty)</label><input type="number" id="qty" value="1" min="1" /></div>
    <div><label>Strike Price ($)</label><input type="number" id="strike" step="0.01" /></div>
    <div>
      <label>Option Type</label>
      <select id="type"><option value="call">Call</option><option value="put">Put</option></select>
    </div>
    <div><label>Expiration Date</label><input type="date" id="expiry" required /></div>
    <div><label>Risk-Free Rate (%)</label><input type="number" id="rf" step="0.01" value="3.42" /></div>
    <div><label>Market Price (Premium)</label><input type="number" id="premium" step="0.01" /></div>
    <div><label>Implied Volatility (%)</label><input type="number" id="iv" readonly placeholder="Auto-Solved" /></div>

    <button type="button" class="btn-calc" onclick="runAnalysis()">Run Full Analysis</button>
  </form>

   <div id="results" style="display: none;"> <div class="summary-grid">
      <div class="summary-item"><label>Prob. of Profit</label><span id="pop">--</span></div>
      <div class="summary-item"><label>Total Cost</label><span id="resCost">--</span></div>
      <div class="summary-item"><label>Max Profit</label><span id="resProfit">--</span></div>
      <div class="summary-item"><label>Max Loss</label><span id="resLoss">--</span></div>
      <div class="summary-item"><label>Breakeven</label><span id="resBreak">--</span></div>
    </div>

    <div class="chart-container"><canvas id="payoffChart"></canvas></div>

    <div class="greeks-grid">
      <div class="greek-card" title="DELTA: Sensitivity to stock price. Measures how much an option's price will change for every $1 move in the underlying stock. 
        Calls have positive delta (0 to +1 ), puts have negative delta (0 to -1 )."><span class="greek-name">DELTA</span><span id="d" class="greek-val"></span></div>

      <div class="greek-card" title="GAMMA: Rate of change in Delta. Measures the rate of change in Delta for a $1 move in the stock. 
        Think of Delta as speed and Gamma as acceleration."><span class="greek-name">GAMMA</span><span id="g" class="greek-val"></span></div>
      
      <div class="greek-card" title="THETA: Daily time decay. Measures how much value an option loses daily as it approaches expiration. 
        This is generally negative for buyers."><span class="greek-name">THETA</span><span id="t" class="greek-val"></span></div>
      
      <div class="greek-card" title="VEGA: Measures sensitivity to implied volatility (IV). High Vega means the option price rises when volatility increases,
        which is good for buyers."><span class="greek-name">VEGA</span><span id="v" class="greek-val"></span></div>
      
      <div class="greek-card" title="RHO: Measures sensitivity to interest rate changes.
        It is generally the least important factor for short-term traders."><span class="greek-name">RHO</span><span id="r" class="greek-val"></span></div>
    </div>

    <h3 style="font-size: 1rem; margin-top: 2rem; color: #4db8ff;">IV Scenario Table</h3>
    <table class="scenario-table">
      <thead><tr><th>IV Shift</th><th>New IV Level</th><th>New Option Price</th></tr></thead>
      <tbody id="scenarioBody"></tbody>
    </table>
  </div>

  <footer>
    <div class="license-box">
      <strong>MIT License</strong><br>
      Copyright (c) 2026 Options Probability and Profit Calculator. Permission is hereby granted, free of charge, to any person obtaining a copy of this software... THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND.
    </div>
    <div class="disclaimer">
      Trading options involves significant risk. Calculations are based on the Black-Scholes-Merton model for educational purposes only. I am not liable for financial losses.
    </div>
    <div class="copyright">&copy; 2026 Options Probability and Profit Calculator. All Rights Reserved.</div>
  </footer>
</div>

<script>
const API_KEY = "d68t7spr01qs7u9judagd68t7spr01qs7u9judb0";
let payoffChart = null;

// Crosshair Plugin Logic
const crosshairPlugin = {
  id: 'crosshair',
  afterDraw: (chart) => {
    if (chart.tooltip?._active?.length) {
      const activePoint = chart.tooltip._active[0];
      const {ctx} = chart;
      const {x, y} = activePoint.element;
      const topY = chart.scales.y.top;
      const bottomY = chart.scales.y.bottom;
      const leftX = chart.scales.x.left;
      const rightX = chart.scales.x.right;
      ctx.save();
      ctx.beginPath();
      ctx.setLineDash([5, 5]);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
      ctx.moveTo(x, topY); ctx.lineTo(x, bottomY);
      ctx.moveTo(leftX, y); ctx.lineTo(rightX, y);
      ctx.stroke();
      ctx.restore();
    }
  }
};

async function refreshVIX() {
  const vixElement = document.getElementById('vixVal');
  const timeElement = document.getElementById('vixTime');
  
  const proxy = "https://corsproxy.io/?";
  const target = encodeURIComponent("https://query1.finance.yahoo.com/v8/finance/chart/^VIX");

  try {
    const response = await fetch(proxy + target);
    const data = await response.json();
    const price = data.chart.result[0].meta.regularMarketPrice;
    
    if (price) {
      vixElement.textContent = price.toFixed(2);
      // Success message
      timeElement.textContent = "Live Sync with Yahoo Finance: " + new Date().toLocaleTimeString();
    }
  } catch (e) {
    vixElement.textContent = "18.50";
    timeElement.textContent = "Yahoo Feed Offline (Showing Fallback)";
  }
}
refreshVIX();
  
const normPDF = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
const normCDF = (x) => {
  const t = 1 / (1 + 0.2316419 * Math.abs(x));
  const d = 0.3989423 * Math.exp(-x * x / 2);
  let p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
  return x > 0 ? 1 - p : p;
};

function blackScholes(S, K, T, r, sigma, type) {
  if (T <= 0) return Math.max(0, type === 'call' ? S - K : K - S);
  const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
  const d2 = d1 - sigma * Math.sqrt(T);
  return type === 'call' ? (S * normCDF(d1) - K * Math.exp(-r * T) * normCDF(d2)) : (K * Math.exp(-r * T) * normCDF(-d2) - S * normCDF(-d1));
}

  function clearProfileDisplay() {
  document.getElementById('companyName').textContent = '';
  document.getElementById('stockLogo').style.display = 'none';
}
  
async function fetchTicketData() {
  const symInput = document.getElementById('symbol');
  const sym = symInput.value.trim().toUpperCase();
  if (!sym) {
    alert("Please enter a ticker symbol first.");
    return;
  }

  // Reset previous results
  document.getElementById('companyName').textContent = '';
  document.getElementById('stockLogo').style.display = 'none';

  try {
    // 1. Fetch current quote (price)
    const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`;
    const quoteRes = await fetch(quoteUrl);
    if (!quoteRes.ok) throw new Error(`Quote fetch failed: ${quoteRes.status}`);
    const quote = await quoteRes.json();

    if (quote.c && quote.c > 0) {
      document.getElementById('stockPrice').value = quote.c.toFixed(2);
    } else {
      console.warn("No current price available", quote);
      // Optional: alert("Could not fetch current price.");
    }

    // 2. Fetch company profile (name + logo)
    const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${API_KEY}`;
    const profileRes = await fetch(profileUrl);
    if (!profileRes.ok) throw new Error(`Profile fetch failed: ${profileRes.status}`);
    const profile = await profileRes.json();

    // Handle profile data
    if (profile.name) {
      document.getElementById('companyName').textContent = profile.name;
    }

    if (profile.logo) {
      const logoImg = document.getElementById('stockLogo');
      logoImg.src = profile.logo;
      logoImg.onload = () => { logoImg.style.display = 'block'; };
      logoImg.onerror = () => { logoImg.style.display = 'none'; };
    }

  } catch (err) {
    console.error("Fetch error:", err);
    // Optional user feedback:
    // alert("Error fetching data. Check symbol and try again.");
  }
}

function runAnalysis() {
  const S = parseFloat(document.getElementById('stockPrice').value);
  const K = parseFloat(document.getElementById('strike').value);
  const prem = parseFloat(document.getElementById('premium').value);
  const r = parseFloat(document.getElementById('rf').value) / 100;
  const type = document.getElementById('type').value;
  const qty = parseInt(document.getElementById('qty').value);
  const expiryVal = document.getElementById('expiry').value;

  if(!expiryVal || isNaN(S) || isNaN(K) || isNaN(prem)) return alert("Fill all fields.");
  const T = (new Date(expiryVal) - new Date()) / 31557600000;
  
  let sigma = 0.5;
  for (let i = 0; i < 60; i++) {
    let diff = prem - blackScholes(S, K, T, r, sigma, type);
    if (Math.abs(diff) < 0.0001) break;
    let d1 = (Math.log(S/K)+(r+0.5*sigma*sigma)*T)/(sigma*Math.sqrt(T));
    sigma += diff / (S*Math.sqrt(T)*normPDF(d1));
  }
  const iv = Math.abs(sigma);
  document.getElementById('iv').value = (iv * 100).toFixed(2);

  const d1 = (Math.log(S/K)+(r+0.5*iv*iv)*T)/(iv*Math.sqrt(T));
  const d2 = d1 - (iv*Math.sqrt(T));

  document.getElementById('pop').textContent = ((type === 'call' ? normCDF(d2) : normCDF(-d2)) * 100).toFixed(1) + "%";
  document.getElementById('resCost').textContent = "$" + (prem * 100 * qty).toLocaleString();
  document.getElementById('resProfit').textContent = type === 'call' ? "Unlimited" : "$" + ((K - prem) * 100 * qty).toLocaleString();
  document.getElementById('resLoss').textContent = "$" + (prem * 100 * qty).toLocaleString();
  document.getElementById('resBreak').textContent = (type === 'call' ? K + prem : K - prem).toFixed(2);

  document.getElementById('d').textContent = (type === 'call' ? normCDF(d1) : normCDF(d1) - 1).toFixed(3);
  document.getElementById('g').textContent = (normPDF(d1) / (S * iv * Math.sqrt(T))).toFixed(4);
  document.getElementById('t').textContent = ((-(S * iv * normPDF(d1)) / (2 * Math.sqrt(T)) / 365)).toFixed(3);
  document.getElementById('v').textContent = ((S * Math.sqrt(T) * normPDF(d1)) / 100).toFixed(3);
  document.getElementById('r').textContent = ((type === 'call' ? K*T*Math.exp(-r*T)*normCDF(d2) : -K*T*Math.exp(-r*T)*normCDF(-d2))/100).toFixed(3);

  updateScenarios(S, K, T, r, iv, type, prem);
  drawWaveChart(S, K, type, prem, qty);
  document.getElementById('results').style.display = 'block';
}

function updateScenarios(S, K, T, r, iv, type, prem) {
  const body = document.getElementById('scenarioBody'); body.innerHTML = '';
  [-10, -5, 0, 5, 10].forEach(s => {
    let ni = Math.max(0.01, iv + (s/100));
    let np = blackScholes(S, K, T, r, ni, type);
    body.innerHTML += `<tr><td>${s}%</td><td>${(ni*100).toFixed(1)}%</td><td style="color:${np > prem ? '#28a745':'#ff4d4d'}">$${np.toFixed(2)}</td></tr>`;
  });
}

function drawWaveChart(S, K, type, prem, qty) {
    const ctx = document.getElementById('payoffChart').getContext('2d');
    
    // 1. Math Setup
    const breakeven = (type === 'call' ? K + prem : K - prem);
    const isCurrentlyProfitable = (type === 'call') ? (S > breakeven) : (S < breakeven);
    
    const labels = [], data = [];
    
    // Logic Fix: Center the chart on the Strike (K) so the "bend" is always visible
    const start = Math.min(S, K) * 0.7; 
    const end = Math.max(S, K) * 1.3; 
    
    for (let p = start; p <= end; p += (end - start)/60) {
        labels.push(p.toFixed(2));
        let intrinsic = type === 'call' ? (p - K) : (K - p);
        data.push((Math.max(0, intrinsic) - prem) * 100 * qty);
    }

    if (payoffChart) payoffChart.destroy();
    
    payoffChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Profit / Loss ($)',
                data: data,
                borderColor: '#4db8ff',
                backgroundColor: 'rgba(77, 184, 255, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0
            }]
        },
        plugins: [crosshairPlugin], 
        options: {
            responsive: true,
            maintainAspectRatio: false, // Allows it to fill the CSS height
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label: function(context) {
                            return `P/L: $${context.parsed.y.toLocaleString()}`;
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            xMin: labels.findIndex(val => parseFloat(val) >= breakeven),
                            xMax: labels.findIndex(val => parseFloat(val) >= breakeven),
                            borderColor: isCurrentlyProfitable ? '#28a745' : '#ff4d4d', 
                            borderWidth: 3,
                            borderDash: [6, 6],
                            label: {
                                display: true,
                                content: 'Breakeven: ' + breakeven.toFixed(2),
                                backgroundColor: isCurrentlyProfitable ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 77, 77, 0.8)',
                                color: '#fff',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            },
            scales: {
                x: { 
                    reverse: (type === 'put'),
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#888', maxRotation: 45 }
                },
                y: { 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#888' }
                }
            }
        }
    });
}
</script>
</body>
</html>
