<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Options POP, Greeks & IV Solver</title>
  <style>
    :root { --primary: #0066cc; --bg: #000000; --text: #ffffff; --success: #28a745; --accent: #6f42c1; }
    body { font-family: 'Segoe UI', sans-serif; background-image: url('https://imgur.com/a/ExEQgAg'); background-size: cover; background-position: center; background-attachment: fixed;
    color: #ffffff; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .container { background: rgba(0, 0, 0, 0.85); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .ticket-row { display: flex; gap: 0.5rem; align-items: flex-end; grid-column: span 2; }
    .ticket-row div { flex: 1; }
    label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85rem; color: #ffffff; }
    input, select { width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    button { padding: 0.7rem 1rem; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-fetch { background: var(--success); color: black; }
    .btn-solve { background: var(--accent); color: white; width: 100%; grid-column: span 1; }
    .btn-calc { background: var(--primary); color: white; width: 100%; grid-column: span 1; font-size: 1rem; }

    #profile { display: flex; align-items: center; gap: 1rem; margin: 1rem 0; padding: 0.8rem; : #eef4ff; border-radius: 8px; display: none; }
    #profile img { height: 30px; border-radius: 4px; }

    #results { margin-top: 2rem; display: none; border-top: 2px solid #eee; padding-top: 1.5rem; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-item { background: #edf2f5; padding: 0.8rem; border-radius: 8px; border-left: 4px solid var(--primary); }
    .summary-item label { color: #cccccc; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
    .summary-item span { font-size: 1.1rem; font-weight: bold; display: block; margin-top: 4px; }

    .greeks-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
    .greek-card { background: #fff; border: 1px solid #ddd; padding: 0.8rem; border-radius: 8px; text-align: center; }
    .greek-name { font-size: 0.7rem; color: #777; font-weight: bold; }
    .greek-val { display: block; font-size: 1.1rem; font-weight: 700; color: var(--primary); }

    @media (max-width: 600px) { .grid-form, .greeks-grid { grid-template-columns: 1fr; } .ticket-row { flex-direction: column; } .btn-solve, .btn-calc { grid-column: span 1; } }
  </style>
</head>
<body>

<div class="container">
  <h1>Options Strategy Builder & IV Solver</h1>

  <div id="profile">
    <img id="compLogo" src="">
    <span id="compName"></span>
  </div>

  <form id="optionForm" class="grid-form">
    <div class="ticket-row">
      <div>
        <label>Ticket Symbol</label>
        <input type="text" id="symbol" placeholder="TSLA" required />
      </div>
      <button type="button" class="btn-fetch" onclick="fetchTicketData()">Fetch Price</button>
    </div>

    <div><label>Stock Price ($)</label><input type="number" id="stockPrice" step="0.01" /></div>
    <div><label>Quantity (Contracts)</label><input type="number" id="qty" value="1" min="1" /></div>
    <div><label>Strike Price ($)</label><input type="number" id="strike" step="0.01" required /></div>
    <div>
      <label>Option Type</label>
      <select id="type">
        <option value="call">Call</option>
        <option value="put">Put</option>
      </select>
    </div>
    <div><label>Expiration Date</label><input type="date" id="expiry" required /></div>
    <div><label>Risk-Free Rate (%)</label><input type="number" id="rf" step="0.01" value="4.5" /></div>
    
    <div>
        <label>Option Market Price ($)</label>
        <input type="number" id="premium" step="0.01" placeholder="Current premium" required />
    </div>
    <div>
        <label>Implied Volatility (%)</label>
        <input type="number" id="iv" step="0.01" placeholder="Solve or enter manual" />
    </div>

    <button type="button" class="btn-solve" onclick="solveForIV()">1. Find IV from Price</button>
    <button type="button" class="btn-calc" onclick="runAnalysis()">2. Calculate Greeks</button>
  </form>

  <div id="results">
    <div class="summary-grid">
      <div class="summary-item"><label>Prob. of Profit</label><span id="pop">--</span></div>
      <div class="summary-item"><label>Total Cost</label><span id="resCost">--</span></div>
      <div class="summary-item"><label>Max Profit</label><span id="resProfit">--</span></div>
      <div class="summary-item"><label>Max Loss</label><span id="resLoss">--</span></div>
      <div class="summary-item"><label>Breakeven</label><span id="resBreak">--</span></div>
    </div>

    <div class="greeks-grid">
      <div class="greek-card"><span class="greek-name">DELTA</span><span class="greek-val" id="d"></span></div>
      <div class="greek-card"><span class="greek-name">GAMMA</span><span class="greek-val" id="g"></span></div>
      <div class="greek-card"><span class="greek-name">THETA</span><span class="greek-val" id="t"></span></div>
      <div class="greek-card"><span class="greek-name">VEGA</span><span class="greek-val" id="v"></span></div>
      <div class="greek-card"><span class="greek-name">RHO</span><span class="greek-val" id="r"></span></div>
    </div>
  </div>
</div>

<script>
const API_KEY = "d68t7spr01qs7u9judagd68t7spr01qs7u9judb0";

// --- Black-Scholes Core ---
const normPDF = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
const normCDF = (x) => {
  const t = 1 / (1 + 0.2316419 * Math.abs(x));
  const d = 0.3989423 * Math.exp(-x * x / 2);
  let p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
  return x > 0 ? 1 - p : p;
};

function blackScholes(S, K, T, r, sigma, type) {
    if (T <= 0) return Math.max(0, type === 'call' ? S - K : K - S);
    const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
    const d2 = d1 - sigma * Math.sqrt(T);
    if (type === 'call') return S * normCDF(d1) - K * Math.exp(-r * T) * normCDF(d2);
    return K * Math.exp(-r * T) * normCDF(-d2) - S * normCDF(-d1);
}

// --- IV Solver (Newton-Raphson) ---
function solveForIV() {
    const S = parseFloat(document.getElementById('stockPrice').value);
    const K = parseFloat(document.getElementById('strike').value);
    const premium = parseFloat(document.getElementById('premium').value);
    const r = parseFloat(document.getElementById('rf').value) / 100;
    const type = document.getElementById('type').value;
    const expiry = new Date(document.getElementById('expiry').value);
    const T = (expiry - new Date()) / (1000 * 60 * 60 * 24 * 365.25);

    if (!S || !K || !premium || T <= 0) return alert("Please fill Price, Strike, Premium, and Date first.");

    let sigma = 0.5; // Initial guess (50%)
    for (let i = 0; i < 100; i++) {
        let price = blackScholes(S, K, T, r, sigma, type);
        let diff = premium - price;
        if (Math.abs(diff) < 0.0001) break;
        
        // Vega (derivative for Newton-Raphson)
        let d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
        let vega = S * Math.sqrt(T) * normPDF(d1);
        sigma = sigma + diff / vega;
        
        if (sigma <= 0) { sigma = 0.0001; break; }
    }
    
    document.getElementById('iv').value = (sigma * 100).toFixed(2);
    runAnalysis(); // Auto-run analysis after solving
}

async function fetchTicketData() {
  const symbol = document.getElementById('symbol').value.toUpperCase();
  if (!symbol) return alert("Enter a symbol first.");
  try {
    const qRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`);
    const qData = await qRes.json();
    if (qData.c) document.getElementById('stockPrice').value = qData.c.toFixed(2);
    
    const pRes = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${API_KEY}`);
    const pData = await pRes.json();
    if (pData.name) {
      document.getElementById('profile').style.display = 'flex';
      document.getElementById('compName').textContent = pData.name;
      document.getElementById('compLogo').src = pData.logo;
    }
  } catch (e) { alert("Error fetching data."); }
}

function runAnalysis() {
  const S = parseFloat(document.getElementById('stockPrice').value);
  const K = parseFloat(document.getElementById('strike').value);
  const qty = parseInt(document.getElementById('qty').value);
  const type = document.getElementById('type').value;
  const iv = parseFloat(document.getElementById('iv').value) / 100;
  const rf = parseFloat(document.getElementById('rf').value) / 100;
  const premium = parseFloat(document.getElementById('premium').value);
  const expiry = new Date(document.getElementById('expiry').value);
  
  const T = (expiry - new Date()) / (1000 * 60 * 60 * 24 * 365.25);
  if (T <= 0 || isNaN(S) || isNaN(iv)) return alert("Check inputs. Ensure IV is solved or entered.");

  const d1 = (Math.log(S/K) + (rf + 0.5 * iv * iv) * T) / (iv * Math.sqrt(T));
  const d2 = d1 - (iv * Math.sqrt(T));

  const pop = (type === 'call' ? normCDF(d2) : normCDF(-d2)) * 100;
  const delta = type === 'call' ? normCDF(d1) : normCDF(d1) - 1;
  const gamma = normPDF(d1) / (S * iv * Math.sqrt(T));
  const vega = (S * Math.sqrt(T) * normPDF(d1)) / 100;
  const theta = (-(S * iv * normPDF(d1)) / (2 * Math.sqrt(T)) - (type === 'call' ? 1 : -1) * rf * K * Math.exp(-rf * T) * normCDF(type === 'call' ? d2 : -d2)) / 365;
  const rho = ((type === 'call' ? 1 : -1) * K * T * Math.exp(-rf * T) * normCDF(type === 'call' ? d2 : -d2)) / 100;

  document.getElementById('pop').textContent = pop.toFixed(1) + "%";
  document.getElementById('resCost').textContent = "$" + (premium * 100 * qty).toLocaleString();
  document.getElementById('resProfit').textContent = type === 'call' ? "Unlimited" : "$" + ((K - premium) * 100 * qty).toLocaleString();
  document.getElementById('resLoss').textContent = "$" + (premium * 100 * qty).toLocaleString();
  document.getElementById('resBreak').textContent = (type === 'call' ? K + premium : K - premium).toFixed(2);
  
  document.getElementById('d').textContent = delta.toFixed(3);
  document.getElementById('g').textContent = gamma.toFixed(4);
  document.getElementById('t').textContent = theta.toFixed(3);
  document.getElementById('v').textContent = vega.toFixed(3);
  document.getElementById('r').textContent = rho.toFixed(3);
  document.getElementById('results').style.display = 'block';
}
</script>
</body>
</html>
