<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Options Analysis Station</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
  <style>
    :root { 
      --primary: #007bff; --success: #28a745; --accent: #6f42c1; --danger: #ff4d4d;
      --glass: rgba(0, 0, 0, 0.9); 
    }
    body { 
      font-family: 'Segoe UI', sans-serif; background-color: #000;
      color: #ffffff; max-width: 950px; margin: 2rem auto; padding: 0 1rem; 
    }
    .container { 
      background: #000; padding: 2.5rem; border-radius: 20px; 
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2rem; }
    .ticket-row { display: flex; gap: 0.5rem; align-items: flex-end !important; grid-column: span 2; }
    label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85rem; color: #fff; }
    input, select { 
      width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; 
      background: #ffffff; color: #000000; font-size: 0.95rem; box-sizing: border-box;
    }
    .btn-fetch { background: var(--success); color: white; padding: 0.85rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-calc { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; grid-column: span 2; margin-top: 10px; padding: 0.85rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .picker-btn { background:#444; color:white; border:none; border-radius:4px; padding: 5px 15px; cursor:pointer; }
    .ov-btn { display:block; width:100%; margin:5px 0; padding:10px; background:#333; color:white; border:1px solid #555; border-radius:6px; cursor:pointer; text-align:left; }
    #results { margin-top: 2.5rem; display: none; }
    .summary-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-item { background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 12px; border-left: 4px solid var(--primary); }
    .greeks-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.6rem; margin-top: 20px; }
    .greek-card { background: rgba(255, 255, 255, 0.08); padding: 1rem; border-radius: 10px; text-align: center; }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center; margin-bottom: 2rem;">Options Analysis Station</h1>

  <form id="optionForm" class="grid-form">
    <div class="ticket-row">
      <div style="flex: 1;">
        <label>Ticker Symbol</label>
        <input type="text" id="symbol" placeholder="e.g. NVDA" oninput="cachedChain=null" />
      </div>
      <button type="button" class="btn-fetch" onclick="fetchTicketData()">Fetch Price</button>
    </div>

    <div><label>Stock Price ($)</label><input type="number" id="stockPrice" step="0.01" /></div>
    <div><label>Contracts (Qty)</label><input type="number" id="qty" value="1" /></div>
    
    <div>
        <label>Expiration Date</label>
        <div style="display: flex; gap: 5px;"><input type="text" id="expiry" readonly /><button type="button" class="picker-btn" onclick="showExpirationPicker()">Pick</button></div>
    </div>
    <div>
        <label>Strike Price ($)</label>
        <div style="display: flex; gap: 5px;"><input type="number" id="strike" step="0.01" /><button type="button" class="picker-btn" onclick="showStrikePicker()">Pick</button></div>
    </div>

    <div><label>Option Type</label><select id="type"><option value="call">Call</option><option value="put">Put</option></select></div>
    <div><label>Risk-Free Rate (%)</label><input type="number" id="rf" step="0.01" value="4.25" /></div>
    <div><label>Dividend Yield (%)</label><input type="number" id="dividend" value="0.00" /></div>
    <div><label>Premium (Market Price)</label><input type="number" id="premium" step="0.01" value="0.00" /></div>
    
    <div style="grid-column: span 2;">
        <label>Implied Volatility (%)</label>
        <input type="text" id="iv" placeholder="Calculated on Pick" />
    </div>

    <button type="button" class="btn-calc" onclick="runAnalysis()">Run Full Analysis</button>
  </form>

  <div id="results"> 
    <div class="summary-grid">
      <div class="summary-item"><label>Prob. of Profit</label><div id="pop">--</div></div>
      <div class="summary-item"><label>Total Cost</label><div id="resCost">--</div></div>
      <div class="summary-item"><label>Max Profit</label><div id="resProfit">--</div></div>
      <div class="summary-item"><label>Max Loss</label><div id="resLoss">--</div></div>
      <div class="summary-item"><label>Breakeven</label><div id="resBreak">--</div></div>
    </div>
    <div style="height: 450px; background: #000; border: 1px solid #333; padding: 10px;">
        <canvas id="payoffChart"></canvas>
    </div>
    <div class="greeks-grid">
      <div class="greek-card"><div>DELTA</div><span id="d">--</span></div>
      <div class="greek-card"><div>GAMMA</div><span id="g">--</span></div>
      <div class="greek-card"><div>THETA</div><span id="t">--</span></div>
      <div class="greek-card"><div>VEGA</div><span id="v">--</span></div>
      <div class="greek-card"><div>RHO</div><span id="r">--</span></div>
    </div>
  </div>
</div>

<script>
const POLYGON_KEY = "khT7kqtgtjpevl6jDgff0B0jPBr2gpqc";
const FINNHUB_KEY = "d6a41gpr01qsjlb9lhj0d6a41gpr01qsjlb9lhjg";
let payoffChart = null, cachedChain = null;

async function fetchTicketData() {
    const sym = document.getElementById('symbol').value.toUpperCase();
    const q = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`).then(r => r.json());
    if(q.c) document.getElementById('stockPrice').value = q.c.toFixed(2);
}

async function getChain() {
    if (cachedChain) return cachedChain;
    const sym = document.getElementById('symbol').value.toUpperCase();
    const res = await fetch(`https://api.polygon.io/v3/reference/options/contracts?underlying_ticker=${sym}&apiKey=${POLYGON_KEY}`).then(r => r.json());
    cachedChain = res.results;
    return cachedChain;
}

async function showExpirationPicker() {
    const data = await getChain();
    const dates = [...new Set(data.map(c => c.expiration_date))].sort();
    const overlay = createOverlay("Select Expiry");
    dates.forEach(d => {
        const btn = document.createElement('button'); btn.className = "ov-btn"; btn.textContent = d;
        btn.onclick = () => { document.getElementById('expiry').value = d; overlay.remove(); };
        overlay.firstChild.appendChild(btn);
    });
}

async function showStrikePicker() {
    const expiry = document.getElementById('expiry').value;
    const type = document.getElementById('type').value;
    const data = await getChain();
    const overlay = createOverlay("Select Strike");
    data.filter(c => c.expiration_date === expiry && c.contract_type === type).forEach(opt => {
        const btn = document.createElement('button'); btn.className = "ov-btn";
        btn.textContent = `$${opt.strike_price} (IV: ${(opt.implied_volatility * 100 || 40).toFixed(2)}%)`;
        btn.onclick = () => {
            document.getElementById('strike').value = opt.strike_price;
            // FIX 1: POPULATE THE SPECIFIED BOX
            document.getElementById('iv').value = (opt.implied_volatility * 100 || 40.00).toFixed(2);
            overlay.remove();
        };
        overlay.firstChild.appendChild(btn);
    });
}

function createOverlay(title) {
    const div = document.createElement('div'); div.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; display:flex; align-items:center; justify-content:center;";
    const box = document.createElement('div'); box.style.cssText = "background:#222; padding:20px; border-radius:12px; width:300px; max-height:70vh; overflow:y-auto;";
    box.innerHTML = `<h3>${title}</h3>`; div.appendChild(box); document.body.appendChild(div);
    return div;
}

function runAnalysis() {
    const S = parseFloat(document.getElementById('stockPrice').value);
    const K = parseFloat(document.getElementById('strike').value);
    const prem = parseFloat(document.getElementById('premium').value);
    const type = document.getElementById('type').value;
    const qty = parseInt(document.getElementById('qty').value);
    const be = type === 'call' ? K + prem : K - prem;

    document.getElementById('resBreak').textContent = be.toFixed(2);
    document.getElementById('resCost').textContent = "$" + (prem * 100 * qty);
    document.getElementById('results').style.display = 'block';
    
    drawChart(S, K, type, prem, qty, be);
}

function drawChart(S, K, type, prem, qty, be) {
    const ctx = document.getElementById('payoffChart').getContext('2d');
    const labels = [], expData = [];
    const range = S * 0.2;
    for (let p = S - range; p <= S + range; p += (range*2)/100) {
        labels.push(p.toFixed(2));
        let profit = type === 'call' ? Math.max(0, p - K) - prem : Math.max(0, K - p) - prem;
        expData.push(profit * 100 * qty);
    }

    if (payoffChart) payoffChart.destroy();
    payoffChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'At Expiry', data: expData, borderColor: '#007bff', fill: true, pointRadius:0 }] },
        options: { 
            responsive:true, maintainAspectRatio:false,
            plugins: {
                annotation: {
                    annotations: {
                        currPrice: { 
                            type: 'line', xMin: labels.indexOf(labels.reduce((a,b) => Math.abs(b-S) < Math.abs(a-S) ? b : a)), 
                            xMax: labels.indexOf(labels.reduce((a,b) => Math.abs(b-S) < Math.abs(a-S) ? b : a)),
                            borderColor: '#ffcc00', borderWidth: 2, 
                            label: { 
                                display: true, content: 'Price', backgroundColor: '#ffcc00', color: '#000',
                                yAdjust: (type === 'call' ? 25 : -25) // FIX 2: Offset from BE
                            } 
                        },
                        breakeven: { 
                            type: 'line', xMin: labels.indexOf(labels.reduce((a,b) => Math.abs(b-be) < Math.abs(a-be) ? b : a)),
                            xMax: labels.indexOf(labels.reduce((a,b) => Math.abs(b-be) < Math.abs(a-be) ? b : a)),
                            borderColor: '#ff4d4d', borderDash: [2, 2],
                            label: { 
                                display: true, content: 'Breakeven', backgroundColor: '#ff4d4d', color: '#fff',
                                yAdjust: (type === 'call' ? -25 : 25) // FIX 2: Offset from Price
                            } 
                        }
                    }
                }
            }
        }
    });
}
</script>
</body>
</html>
