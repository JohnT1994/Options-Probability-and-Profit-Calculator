<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Options Analysis Station</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
  <style>
    :root { --primary: #007bff; --success: #28a745; --glass: rgba(0, 0, 0, 0.9); }
    body { font-family: 'Segoe UI', sans-serif; background: #0b0e11; color: #fff; max-width: 950px; margin: 2rem auto; padding: 0 1rem; }
    .container { background: var(--glass); padding: 2.5rem; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 12px 50px rgba(0,0,0,0.8); }
    .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2rem; }
    .full-width { grid-column: span 2; }
    label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85rem; color: #888; }
    input, select { width: 100%; padding: 0.75rem; border: 1px solid #333; border-radius: 8px; background: #161a1e; color: #fff; font-size: 0.95rem; box-sizing: border-box; }
    button { padding: 0.85rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-calc { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; margin-top: 10px; }
    .picker-btn { display:block; width:100%; margin:4px 0; padding:12px; background:#222; color:white; border:1px solid #444; border-radius:6px; cursor:pointer; text-align:left; }
    .picker-btn:hover { border-color: var(--primary); background: #2a2e33; }
    .summary-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin: 2rem 0; }
    .summary-item { background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 12px; border-top: 3px solid var(--primary); text-align: center; }
    .summary-item label { font-size: 0.6rem; text-transform: uppercase; }
    .summary-item span { font-size: 1.1rem; font-weight: bold; display: block; }
    .chart-container { height: 400px; background: #000; padding: 10px; border-radius: 12px; border: 1px solid #222; }
  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align:center; margin-top:0;">Options Analysis Station</h2>
  
  <div class="grid-form">
    <div class="full-width" style="display:flex; gap:10px;">
        <div style="flex:2"><label>Symbol</label><input type="text" id="symbol" placeholder="SOFI" oninput="cachedChain=null"></div>
        <div style="flex:1; align-self:flex-end;"><button onclick="fetchTicketData()" style="background:var(--success); color:white; width:100%;">Fetch Price</button></div>
    </div>
    
    <div><label>Stock Price</label><input type="number" id="stockPrice" step="0.01"></div>
    <div><label>Qty</label><input type="number" id="qty" value="1"></div>
    
    <div><label>Expiration</label><div style="display:flex; gap:5px;"><input type="text" id="expiry" readonly><button onclick="showExpirationPicker()">Pick</button></div></div>
    <div><label>Strike</label><div style="display:flex; gap:5px;"><input type="number" id="strike" step="0.01"><button onclick="showStrikePicker()">Pick</button></div></div>
    
    <div><label>Type</label><select id="type"><option value="call">Call</option><option value="put">Put</option></select></div>
    <div><label>Premium</label><input type="number" id="premium" step="0.01" style="border-color: var(--success)"></div>
  </div>

  <button class="btn-calc" onclick="runAnalysis()">Run Full Analysis</button>

  <div id="results" style="display:none;">
    <div class="summary-grid">
        <div class="summary-item"><label>P.O.P</label><span id="pop">--</span></div>
        <div class="summary-item"><label>Cost</label><span id="resCost">--</span></div>
        <div class="summary-item"><label>Max Profit</label><span id="resProfit">--</span></div>
        <div class="summary-item"><label>Max Loss</label><span id="resLoss">--</span></div>
        <div class="summary-item"><label>Breakeven</label><span id="resBreak">--</span></div>
    </div>
    <div class="chart-container"><canvas id="payoffChart"></canvas></div>
  </div>
</div>

<script>
const POLYGON_KEY = "khT7kqtgtjpevl6jDgff0B0jPBr2gpqc";
const FINNHUB_KEY = "d6a41gpr01qsjlb9lhj0d6a41gpr01qsjlb9lhjg";
let payoffChart = null;
let cachedChain = null;

async function fetchTicketData() {
    const sym = document.getElementById('symbol').value.toUpperCase();
    const q = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`).then(r => r.json());
    if (q.c) document.getElementById('stockPrice').value = q.c.toFixed(2);
}

async function getChain() {
    const sym = document.getElementById('symbol').value.toUpperCase();
    if (cachedChain?.symbol === sym) return cachedChain.data;
    const res = await fetch(`https://api.polygon.io/v3/reference/options/contracts?underlying_ticker=${sym}&limit=1000&apiKey=${POLYGON_KEY}`).then(r => r.json());
    const data = {};
    res.results.forEach(c => {
        if (!data[c.expiration_date]) data[c.expiration_date] = { calls: [], puts: [] };
        data[c.expiration_date][c.contract_type + 's'].push({ strike: c.strike_price, mid: (c.last_quote?.bid + c.last_quote?.ask)/2 || c.last_quote?.last || 0 });
    });
    cachedChain = { symbol: sym, data };
    return data;
}

async function showExpirationPicker() {
    const chain = await getChain();
    const overlay = createOverlay("Dates");
    Object.keys(chain).sort().forEach(d => {
        const btn = document.createElement('button'); btn.className="picker-btn";
        const [y,m,day] = d.split('-'); btn.textContent = `${day}/${m}/${y}`;
        btn.onclick = () => { document.getElementById('expiry').value = btn.textContent; overlay.remove(); };
        overlay.firstChild.appendChild(btn);
    });
}

async function showStrikePicker() {
    const exp = document.getElementById('expiry').value;
    if (!exp) return;
    const [d,m,y] = exp.split('/');
    const chain = await getChain();
    const list = chain[`${y}-${m}-${d}`][document.getElementById('type').value + 's'];
    const overlay = createOverlay("Strikes");
    list.sort((a,b)=>a.strike-b.strike).forEach(o => {
        if (Math.abs(o.strike - parseFloat(document.getElementById('stockPrice').value)) > 20) return;
        const btn = document.createElement('button'); btn.className="picker-btn";
        btn.textContent = `$${o.strike} (Mid: $${o.mid.toFixed(2)})`;
        btn.onclick = () => { 
            document.getElementById('strike').value = o.strike; 
            document.getElementById('premium').value = o.mid.toFixed(2);
            overlay.remove(); 
        };
        overlay.firstChild.appendChild(btn);
    });
}

function createOverlay(t) {
    const div = document.createElement('div'); div.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:99";
    const box = document.createElement('div'); box.style.cssText="background:#1a1a1a;padding:20px;border-radius:12px;width:300px;max-height:70vh;overflow-y:auto;";
    box.innerHTML = `<h3>${t}</h3>`; div.appendChild(box); document.body.appendChild(div);
    div.onclick = (e) => { if(e.target===div) div.remove(); }; return div;
}

const normPDF = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
const normCDF = (x) => {
    let t = 1 / (1 + 0.2316419 * Math.abs(x));
    let d = 0.3989423 * Math.exp(-x * x / 2);
    let p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return x > 0 ? 1 - p : p;
};

function blackScholes(S, K, T, r, v, type) {
    if (T <= 0) return Math.max(0, type === 'call' ? S - K : K - S);
    let d1 = (Math.log(S / K) + (r + 0.5 * v * v) * T) / (v * Math.sqrt(T));
    let d2 = d1 - v * Math.sqrt(T);
    return type === 'call' ? S * normCDF(d1) - K * Math.exp(-r * T) * normCDF(d2) : K * Math.exp(-r * T) * normCDF(-d2) - S * normCDF(-d1);
}

function runAnalysis() {
    const S = parseFloat(document.getElementById('stockPrice').value);
    const K = parseFloat(document.getElementById('strike').value);
    const prem = parseFloat(document.getElementById('premium').value);
    const type = document.getElementById('type').value;
    const [d,m,y] = document.getElementById('expiry').value.split('/').map(Number);
    const T = Math.max(0.001, (new Date(y, m-1, d) - new Date()) / (1000 * 3600 * 24 * 365));
    const r = 0.0425;

    let v = 0.5;
    for(let i=0; i<40; i++){
        let diff = prem - blackScholes(S,K,T,r,v,type);
        if(Math.abs(diff)<0.001) break;
        let d1 = (Math.log(S/K)+(r+0.5*v*v)*T)/(v*Math.sqrt(T));
        v += diff/(S*Math.sqrt(T)*normPDF(d1));
    }

    const d1 = (Math.log(S/K)+(r+0.5*v*v)*T)/(v*Math.sqrt(T));
    const d2 = d1 - v * Math.sqrt(T);

    document.getElementById('pop').textContent = (type==='call'?normCDF(d2):normCDF(-d2)*100).toFixed(1) + "%";
    document.getElementById('resCost').textContent = "$" + (prem * 100).toFixed(0);
    document.getElementById('resBreak').textContent = (type==='call'?K+prem:K-prem).toFixed(2);
    document.getElementById('resProfit').textContent = type==='call'?"Unlimited":"$" + ((K-prem)*100).toFixed(0);
    document.getElementById('resLoss').textContent = "$" + (prem*100).toFixed(0);
    
    document.getElementById('results').style.display='block';
    updateChart(S,K,T,r,v,type,prem);
}

function updateChart(S,K,T,r,v,type,prem) {
    const labels = [], expData = [], nowData = [];
    for(let p = S*0.8; p <= S*1.2; p += (S*0.4/40)) {
        labels.push(p.toFixed(2));
        expData.push(((type==='call'?Math.max(0, p-K):Math.max(0, K-p)) - prem)*100);
        nowData.push((blackScholes(p,K,T,r,v,type) - prem)*100);
    }
    if(payoffChart) payoffChart.destroy();
    payoffChart = new Chart(document.getElementById('payoffChart'), {
        type: 'line',
        data: { labels, datasets: [
            { label: 'At Expiry', data: expData, borderColor: '#007bff', fill: false, pointRadius: 0 },
            { label: 'Today (T+0)', data: nowData, borderColor: '#fff', borderDash: [5,5], fill: false, pointRadius: 0 }
        ]},
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#222' } }, y: { grid: { color: '#222' } } } }
    });
}
</script>
</body>
</html>
